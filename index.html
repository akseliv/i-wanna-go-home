<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>&#9876; Rogue Homesickness Adventure</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 640,
        height: 448,
        zoom: 1.5,
        pixelArt: true,
        scene: {
            preload: preload,
            create: create,
            update: update,
            extend: {
                getContext: getContext,
                createFirstLevel: createFirstLevel,
                createItem: createItem,
                createHomeDoor: createHomeDoor
            }
        },
        physics: {
            default: 'arcade',
            arcade: {
                debug: false
            }
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.spritesheet('player', 'assets/anim_player.png', { frameWidth: 32, frameHeight: 32 });
        this.load.image('ground_2', 'assets/tile_ground_03.png');
        this.load.image('ground_4', 'assets/tile_ground_04.png');
        this.load.image('tile_edge_1', 'assets/tile_edgewall1.png');
        this.load.image('tile_edge_2', 'assets/tile_edgewall2.png');
        this.load.image('tile_edge_3', 'assets/tile_edgewall3.png');
        this.load.image('tile_edge_4', 'assets/tile_edgewall4.png');
        this.load.image('item_sword', 'assets/item_sword.png');

        this.load.image('grass', 'assets/tile_grass_03.png');
        this.load.image('water', 'assets/tile_water.png');
        this.load.spritesheet('lava', 'assets/anim_lava_02.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('home_door', 'assets/anim_p0rtal2.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('next_door', 'assets/anim_p0rtal.png', { frameWidth: 32, frameHeight: 32 });

    }

    function create ()
    {
        // setiup animations
        let config = {
            key: 'lava',
            frames: this.anims.generateFrameNumbers('lava'),
            frameRate: 20,
            repeat: -1
        };

        this.anims.create(config);

        config = {
            key: 'player',
            frames: this.anims.generateFrameNumbers('player'),
            frameRate: 20,
            repeat: -1
        };

        this.anims.create(config);

        config = {
            key: 'home_door',
            frames: this.anims.generateFrameNumbers('home_door'),
            frameRate: 5,
            repeat: -1
        };

        this.anims.create(config);

        config = {
            key: 'next_door',
            frames: this.anims.generateFrameNumbers('next_door'),
            frameRate: 5,
            repeat: -1
        };

        this.anims.create(config);

        player = {};
        playerItems = [];
        shelfItems = [];
        levelSprites = [];
        homeSickness = 0;

        this.bounds = [];
        bounds = this.bounds;
        for(i = 0; i < 8;i++) {
            let bound = this.physics.add.sprite(160+16,96+16+i*32, 'tile_edge_4');
            bound.body.immovable = true;
            bounds.push(bound);
        }
        for(i = 0; i < 8;i++) {
            let bound = this.physics.add.sprite(448+16,96+16+i*32, 'tile_edge_2');
            bound.body.immovable = true;
            bounds.push(bound);
        }
        for(i = 0; i < 8;i++) {
            let bound = this.physics.add.sprite(192+16+i*32,64+16, 'tile_edge_1');
            bound.body.immovable = true;
            bounds.push(bound);
        }
        for(i = 0; i < 8;i++) {
            let bound = this.physics.add.sprite(192+16+i*32,352+16, 'tile_edge_3');
            bound.body.immovable = true;
            bounds.push(bound);
        }

        this.createFirstLevel();
    }
    const playerControls = function(player){

        player.setVelocityX(0);
        player.setVelocityY(0);
        if (cursors.left.isDown) {
            player.setVelocityX(-160);
        } else if(cursors.right.isDown){
            player.setVelocityX(160);
        } else if(cursors.up.isDown){
            player.setVelocityY(-160);
        } else if(cursors.down.isDown){
            player.setVelocityY(160)
        }
    }

    function update () {
        if(player.body){
            playerControls(player);
        }
    }

    const firstLevelTiles = Array(64).fill('ground_4');

    function createFirstLevel() {
        let xShift = 0;
        let yShift = 0;
        
        for (i = 0; i < 64; i++) { 

            if(i > 0 && i % 8 == 0){
                xShift = 0;
                yShift = yShift +32;
            }
            const sprite = this.physics.add.sprite(192+xShift+16,96+yShift+16, firstLevelTiles[i]);
            levelSprites.push(sprite);
            xShift = xShift + 32;
        }
        player = createPlayer();
        this.createItem(320-16, 224-16, 'item_sword');
        this.createHomeDoor(320-16, 128-16);
        this.physics.add.collider(player, this.bounds);
        cursors = this.input.keyboard.createCursorKeys();

    }

    function getContext(){
        //dirty hack to get the correct context in functions
        return game.scene.scenes[0];
    }
    
    const getFilledArray = function(len, tile) {
        return Array(len).fill(tile);
    }

    const createLevel = function() {
        const grass = getFilledArray(16,'grass');
        const lava = getFilledArray(16,'lava');
        const water = getFilledArray(16,'water');
        const ground = getFilledArray(16,'ground_4');

        const levelTiles = shuffle([...grass,...lava,...water,...ground]);

        let xShift = 0;
        let yShift = 0;

        let doorPositions = [];
        const doorOne = _.random(16);
        const doorTwo = _.random(16);
        doorPositions[doorOne] = 1;
        doorPositions[doorTwo] = 2;

        player = createPlayer();

        for (i = 0; i < 64; i++) { 

            if(i > 0 && i % 8 == 0){
                xShift = 0;
                yShift = yShift +32;
            }
            const sprite = getContext().physics.add.sprite(192+xShift+16,96+yShift+16, levelTiles[i]);
            if(getContext().anims.anims.entries[levelTiles[i]]){
                sprite.anims.play('lava');
            }
            levelSprites.push(sprite);

            // create next doors
            if(doorPositions[i+1]){
                createNextDoor(192+xShift+16,96+yShift+16);
            }

            // create home door
            if(i == 56){
                this.createHomeDoor(192+xShift+16,96+yShift+16);
            }

            xShift = xShift + 32;
        }
        getContext().physics.add.collider(player, this.bounds);
        cursors = getContext().input.keyboard.createCursorKeys();


    }

    const createPlayer = function(){
        const player = getContext().physics.add.sprite(320-16, 352-16, 'player');
        player.anims.play('player');
        player.depth = 9000;
        return player;
    }

    function createItem(x,y,item) {
        const sprite = this.physics.add.sprite(x,y,item);
        levelSprites.push(sprite);
        this.physics.add.overlap(
            sprite, 
            player, 
            (sprite, player) => {
                playerItems.push(item);
                sprite.destroy()
            })
    }
    const goHome = function() {
        levelSprites.forEach(sprite => sprite.destroy());
        shelfItems = [...playerItems];
        playerItems = [];
        createLevel();

    }

    function createHomeDoor(x,y) {
        const sprite = getContext().physics.add.sprite(x,y,'home_door');
        sprite.anims.play('home_door');
        levelSprites.push(sprite);
        getContext().physics.add.overlap(
            sprite, 
            player, 
            (sprite, player) => {
                player.destroy();
                goHome();
            })
    }

    function createNextDoor(x,y) {
        const sprite = getContext().physics.add.sprite(x,y,'next_door');
        sprite.anims.play('next_door');
        levelSprites.push(sprite);
        getContext().physics.add.overlap(
            sprite, 
            player, 
            (sprite, player) => {
                player.destroy();
                console.log('teleported somewhere else');
            })
    }

    function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

</script>

</body>
</html>